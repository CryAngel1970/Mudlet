app-id: org.mudlet.mudlet
runtime: org.kde.Platform
runtime-version: '5.15-22.08'
sdk: org.kde.Sdk
command: mudlet
rename-desktop-file: mudlet.desktop
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --device=dri
  - --socket=pulseaudio
  - --share=network
# start with no sandboxing for now
  - --filesystem=home
  -
modules:
# TODO - check that all library versions are up to date...
  - name: lua-5.1
    buildsystem: simple
    build-commands:
      - make -j $FLATPAK_BUILDER_N_JOBS CFLAGS="$CFLAGS -fPIC -DLUA_USE_LINUX" linux
      - make INSTALL_TOP=$FLATPAK_DEST TO_LIB='liblua.a liblua.so.5.1.5' install
      - ln -sf liblua.so.5.1.5 $FLATPAK_DEST/lib/liblua.so
      - ln -sf liblua.so.5.1.5 $FLATPAK_DEST/lib/liblua.so.5.1
      - install -Dm0644 etc/lua.pc $FLATPAK_DEST/lib/pkgconfig/lua.pc
      - ln -sf lua.pc $FLATPAK_DEST/lib/pkgconfig/lua51.pc
      - ln -sf lua.pc $FLATPAK_DEST/lib/pkgconfig/lua5.1.pc
      - ln -sf lua.pc $FLATPAK_DEST/lib/pkgconfig/lua-5.1.pc
    sources:
      - type: archive
        url: 'https://www.lua.org/ftp/lua-5.1.5.tar.gz'
        sha256: 2640fc56a795f29d28ef15e13c34a47e223960b0240e8cb0a82d9b0738695333
      - type: patch
        path: lua-5.1.5-so.patch
      - type: shell
        commands:
          - sed -i "s|/usr/local|$FLATPAK_DEST|" etc/lua.pc src/luaconf.h
    cleanup:
      - '*.a'
      - /bin
      - /include
      - /lib/pkgconfig
      - /man

  - name: libsecret
    buildsystem: meson
    config-opts:
      - -Dmanpage=false
      - -Dvapi=false
      - -Dgtk_doc=false
      - -Dintrospection=false
      # https://gitlab.gnome.org/GNOME/libsecret/-/issues/49
      - -Dgcrypt=false
    sources:
      - commit: 3fe635e64efd4b8dbc9ec3548b0bc8034c7665c4
        tag: 0.20.4
        type: git
        url: https://gitlab.gnome.org/GNOME/libsecret.git

  - name: libzip
    buildsystem: cmake-ninja
    config-opts:
    - "-DCMAKE_BUILD_TYPE=Release"
    - "-DCMAKE_INSTALL_LIBDIR=lib"
    cleanup:
    - "/include"
    - "/bin"
    - "/share"
    - "/lib/pkgconfig"
    - "/lib/*.la"
    sources:
    - type: archive
      url: https://libzip.org/download/libzip-1.9.2.tar.xz
      sha256: c93e9852b7b2dc931197831438fee5295976ee0ba24f8524a8907be5c2ba5937

  - name: pugixml
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_SHARED_LIBS=on .
    sources:
      - type: archive
        url: https://github.com/zeux/pugixml/releases/download/v1.11.4/pugixml-1.11.4.tar.gz
        sha256: 8ddf57b65fb860416979a3f0640c2ad45ddddbbafa82508ef0a0af3ce7061716

  - name: yajl
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - '-DCMAKE_BUILD_TYPE=Release'
    sources:
      - type: archive
        url: 'https://github.com/lloyd/yajl/archive/refs/tags/2.1.0.tar.gz'
        sha256: 3fb73364a5a30efe615046d07e6db9d09fd2b41c763c5f7d3bfb121cd5c5ac5a


  - name: mudlet
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
# commented out for testing
#      - type: archive
#        url: https://www.mudlet.org/download/Mudlet-4.16.0.tar.xz
#        sha256: aa36c80e6e75761f834032f9ca7573b3a7991998afe90017c535be5c523af30b
      - type: git
        url: https://github.com/Mudlet/Mudlet.git
        branch: development